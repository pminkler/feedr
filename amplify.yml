version: 1
env:
  variables:
    SHELL: "/bin/bash"
    NODE_ENV: "production"
    CI: "true"
backend:
  phases:
    build:
      commands:
        - npm ci
        - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
        - npm run typecheck
        - npm test
        - npm run test:verify-failures
    build:
      commands:
        - NODE_OPTIONS=--max-old-space-size=4096 npm run generate
  artifacts:
    baseDirectory: .amplify-hosting/static
    files:
      - '**/*'
test:
  phases:
    preTest:
      commands:
        - npx pm2 start "npx serve .amplify-hosting/static" --name nuxt-app
        - npx wait-on --timeout 60000 http://localhost:3000
    test:
      commands:
        - 'npx cypress run --reporter mochawesome --reporter-options "reportDir=cypress/report/mochawesome-report,overwrite=false,html=false,json=true,timestamp=mmddyyyy_HHMMss"'
    postTest:
      commands:
        - npx mochawesome-merge cypress/report/mochawesome-report/mochawesome*.json > cypress/report/mochawesome.json
        - npx pm2 delete nuxt-app
  artifacts:
    baseDirectory: cypress
    configFilePath: '**/mochawesome.json'
    files:
      - '**/*.png'
      - '**/*.mp4'
cache:
  paths:
    - node_modules/**/*
    - .nuxt/**/*
    - .output/**/*
    - .amplify-hosting/**/*
    - ~/.npm/**/*